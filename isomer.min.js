function Layer(t){this.items=[],this.z=t,this.map={},this.world=null}function World(t){this.canvas=t.canvas,this.ctx=this.canvas.getContext("2d"),this.ctx.webkitspritesmoothingEnabled=!1,this.width=canvas.width,this.height=canvas.height,this.cell=t.cell,this.cx=0,this.cy=0,this.center={x:0,y:0,z:0},this.projection=this.project(this.center.x,this.center.y,this.center.z),this.layers=[],this._changed=!1,this.init()}function Item(t){this.sprite=t.sprite,this.width=t.width,this.height=t.height,this.x=t.x,this.y=t.y,this.z=t.z,this.sx=t.sx,this.sy=t.sy,this.animations=[],this._discovered=!1}function Block(t){Item.call(this,{sprite:t.sprite,width:t.width,height:t.height,x:t.x,y:t.y,z:t.z,sx:t.sx||0,sy:t.sy||0})}function Player(t){Item.call(this,{sprite:t,width:64,height:64,x:0,y:0,z:1,sx:0,sy:192}),this._discovered=!0}function Animation(t,i,s,e){this.item=t,this.props=i,this.sprite=i.sprite,this.frames=i.frames,this.startX=this.startY=this.startZ=null,this.x=this.y=this.z=null,this.start=null,this.interval=s||1,this.callback=e}Layer.prototype.init=function(t){this.world=t},Layer.prototype.has=function(t){return this.items.indexOf(t)>=0},Layer.prototype.render=function(t){for(var i=-this.world.cx,s=-this.world.cx+this.world.width,e=-this.world.cy,h=-this.world.cy+this.world.height,r=0,o=this.items.length;o>r;r++){var n=this.items[r];n.in(i,e,s,h)&&(n._discovered||n.neighbors(this.world.player))&&(n._discovered=!0,t.globalAlpha=1,n.covers(this.world.player)&&(t.globalAlpha=.6),n.render(t),n.animation())}},Layer.prototype.add=function(t){t.init(this),this.insert(t)},Layer.prototype.insert=function(t){if(0===this.items.length)return this.items.push(t),void 0;var i=Layer.search(t,this.items,Item.compare);this.items.splice(i,0,t)},Layer.prototype.get=function(t,i,s){if(0===this.items.length)return!1;for(var e=0;e<this.items.length;++e){var h=this.items[e];if(t===h.x&&i===h.y&&s===h.z)return h}return!1},Layer.prototype.remove=function(t){var i=this.items.indexOf(t);-1!==i&&this.items.splice(i,1)},Layer.prototype.sort=function(){this.items=this.items.sort(Item.compare)},Layer.compare=function(t,i){return t.z>i.z?-1:t.z<i.z?1:0},Layer.search=function(t,i,s){for(var e=0,h=i.length-1,r=0;h>=e;){r=e+h>>1;var o=s(i[r],t);if(0>o)e=r+1;else{if(!(o>0))break;h=r-1}}return 0>o&&r++,r},World.prototype.init=function(){var t=this,i=window.webkitRequestAnimationFrame||window.RequestAnimationFrame;i(function s(){t.render(),i(s)})},World.prototype.project=function(t,i,s){return{x:Math.round((t-i)*this.cell.width/2),y:Math.round(((t+i)/2-s)*this.cell.height)}},World.prototype.render=function(){if(this._changed){this._changed=!1,this.cx=Math.round(this.width/2-this.projection.x),this.cy=Math.round(this.height/2-this.projection.y),this.ctx.save(),this.ctx.clearRect(0,0,this.width,this.height),this.ctx.translate(this.cx,this.cy);for(var t=0,i=this.layers.length;i>t;t++)Math.random()>.75&&this.layers[t].sort(),this.layers[t].render(this.ctx);this.ctx.restore()}},World.prototype.add=function(t){var i=this.getLayer(t);i&&i.add(t)},World.prototype.getLayer=function(t){for(var i=0,s=this.layers.length;s>i;i++)if(this.layers[i].z===t.z)return this.layers[i];return!1},World.prototype.addLayer=function(t){t.init(this),this.layers.push(t)},World.prototype.setPlayer=function(t){this.player=t,this.layers=[],this.setCenter(t.x,t.y,t.z),this.add(t)},World.prototype.setCenter=function(t,i,s){this.center={x:t,y:i,z:s},this.projection=this.project(t,i,s),0===this.layers.length&&(this.addLayer(new Layer(this.player.z-1)),this.addLayer(new Layer(this.player.z)))},World.prototype.handleMove=function(t){this.player===t&&this.setCenter(t.x,t.y,t.z)},Item.prototype.init=function(t){this.layer=t,this.world=t.world,this.position(this.x,this.y,this.z),this.offset(this.sx,this.sy)},Item.prototype.position=function(t,i,s){this.x=t,this.y=i,this.z=s,this.projection=this.world.project(this.x,this.y,this.z),this.world.handleMove(this),this.world._changed=!0},Item.prototype.in=function(t,i,s,e){var h=this.width,r=this.height,o=this.projection;return o.x+h>=t&&o.x-h<=s&&o.y+r>=i&&o.y-r<=e},Item.prototype.offset=function(t,i){this.sx=t||0,this.sy=i||0,this.world._changed=!0},Item.prototype.move=function(t,i,s){this.position(this.x+t,this.y+i,this.z+s)},Item.prototype.covers=function(t){if(this.z!==t.z||Item.compare(this,t)<=0||this===t)return!1;var i=this.projection.x-t.projection.x,s=this.projection.y-t.projection.y,e=i*i+s*s;return 3e3>e?!0:void 0},Item.prototype.neighbors=function(t){var i=this.x-t.x,s=this.y-t.y,e=i*i+s*s;return 9>e?!0:void 0},Item.prototype.render=function(){},Item.prototype.animate=function(t,i,s){this.animations.push(new Animation(this,t,i,s)),this.world._changed=!0},Item.prototype.animation=function(){if(0!==this.animations.length)for(;0!==this.animations.length;){var t=this.animations[0];t.init();{if(!(t.start+t.interval<=Date.now())){t.run(),this.world._changed=!0;break}this.animations.shift(),t.end(),this.world._changed=!0}}},Item.prototype.reset=function(){if(0!==this.animation.length){for(var t=0,i=this.animation.length;i>t;t++){var s=this.animation[t];s.init(),s.end()}this.animation=[]}},Item.prototype.remove=function(){this.layer.remove(this)},Item.compare=function(t,i){return t.x+t.y-i.x-i.y},Block.prototype=Object.create(Item.prototype),Block.prototype.constructor=Block,Block.prototype.render=function(t){t.drawImage(this.sprite,this.sx,this.sy,this.width,this.height,this.projection.x-32,this.projection.y-16,this.width,this.height)},Player.prototype=Object.create(Item.prototype),Player.prototype.constructor=Player,Player.prototype.command=function(t,i,s){if("move"===t){var e=0;i.dy>0?e=192:i.dx>0?e=64:i.dx<0&&(e=128),this.animate({dx:i.dx,dy:i.dy,dz:i.dz,sy:e,frames:4},300,s)}else s()},Player.prototype.render=function(t){t.drawImage(this.sprite,this.sx,this.sy,this.width,this.height,this.projection.x-32,this.projection.y-24,this.width,this.height)},Animation.prototype.init=function(){if(null===this.start){this.start=Date.now(),this.x=this.startX=this.item.x,this.y=this.startY=this.item.y,this.z=this.startZ=this.item.z;for(var t=["x","y","z"],i=0;i<t.length;i++){var s=t[i];this.props.hasOwnProperty(s)?this[s]=this.props[s]:this.props.hasOwnProperty("d"+s)&&(this[s]+=this.props["d"+s])}this.item.layer.get(this.x,this.y,this.z)&&(this.x=this.startX,this.y=this.startY,this.z=this.startZ)}},Animation.prototype.run=function(){var t=(Date.now()-this.start)/this.interval,i=Math.round(t*(this.frames-1));0>t&&(t=0),this.item.offset(this.item.width*i,this.props.sy),this.item.position(this.startX+(this.x-this.startX)*t,this.startY+(this.y-this.startY)*t,this.startZ+(this.z-this.startZ)*t)},Animation.prototype.end=function(){this.item.position(this.x,this.y,this.z),this.sprite&&(this.item.sprite=this.sprite),this.callback&&this.callback()};
//# sourceMappingURL=isomer.min.js.map