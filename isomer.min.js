function Sprites(t){this.urls=t}function Region(t,i,s){this.items=[],this.x=t,this.y=i,this.z=s,this.lx=this.x-5,this.ly=this.y-5,this.lz=this.z-5,this.rx=this.x+5,this.ry=this.y+5,this.rz=this.z+5,this.world=null}function World(t){this.canvas=t.canvas,this.ctx=this.canvas.getContext("2d"),this.ctx.webkitspritesmoothingEnabled=!1,this.width=canvas.width,this.height=canvas.height,this.cell=t.cell,this.cx=0,this.cy=0,this.center={x:0,y:0,z:0},this.projection=this.project(this.center.x,this.center.y,this.center.z),this.regions=[],this._changed=!1,this.init()}function Item(t){this.sprite=t.sprite,this.width=t.width,this.height=t.height,this.x=t.x,this.y=t.y,this.z=t.z,this.sx=t.sx,this.sy=t.sy,this.animations=[],this._discovered=!1}function Block(t){Item.call(this,{sprite:t.sprite,width:t.width,height:t.height,x:t.x,y:t.y,z:t.z,sx:t.sx||0,sy:t.sy||0})}function Player(t){Item.call(this,{sprite:t,width:64,height:64,x:0,y:0,z:0,sx:0,sy:192}),this._discovered=!0}function Animation(t,i,s,e){this.item=t,this.sprite=i.sprite,this.frames=i.frames,this.sy=i.sy,this.x=0|i.x,this.y=0|i.y,this.z=0|i.z,this.initial=null,this.start=null,this.duration=s||1,this.callback=e}Sprites.prototype.load=function(t){var i=Object.keys(this.urls),s=i.length,e={};i.forEach(function(i){var o=new Image;o.onload=function(){e[i]=this,0===--s&&t(e)},o.src=this.urls[i]},this)},Region.prototype.init=function(t){this.world=t,this.ctx=t.ctx},Region.prototype.has=function(t){return this.items.indexOf(t)>=0},Region.prototype.contains=function(t){var i=Math.round(t.x),s=Math.round(t.y),e=Math.round(t.z);return this.lx<=i&&i<this.rx&&this.ly<=s&&s<this.ry&&this.lz<=e&&e<this.rz},Region.prototype.render=function(t){for(var i=-this.world.cx,s=-this.world.cx+this.world.width,e=-this.world.cy,o=-this.world.cy+this.world.height,h=this.world.player.z,n=0;n<this.items.length;n++){var r=this.items[n];if(r.z<h)break;if(r.in(i,e,s,o)&&(r._discovered||r.neighbors(this.world.player))){r._discovered=!0;var a=r.covers(this.world.player);a&&(this.ctx.save(),this.ctx.globalAlpha=.5),r.render(t),r.animation(t),a&&this.ctx.restore()}}},Region.prototype.add=function(t){t.init(this),this.insert(t)},Region.prototype.isVisible=function(t){return this.lz<=t+5&&t-5<=this.rz},Region.prototype.insert=function(t){if(0===this.items.length)return this.items.push(t),void 0;var i=Region.search(t,this.items,Item.compare);this.items.splice(i,0,t)},Region.prototype.get=function(t,i,s){if(0===this.items.length)return!1;for(var e=0;e<this.items.length;++e){var o=this.items[e];if(t===o.x&&i===o.y&&s===o.z)return o}return!1},Region.prototype.remove=function(t){var i=this.items.indexOf(t);-1!==i&&this.items.splice(i,1)},Region.prototype.sort=function(){this.items=this.items.sort(Item.compare)},Region.compare=function(t,i){return t.z>i.z?-1:t.z<i.z?1:t.x+t.y-i.x-i.y},Region.search=function(t,i,s){for(var e=0,o=i.length-1,h=0;o>=e;){h=e+o>>1;var n=s(i[h],t);if(0>n)e=h+1;else{if(!(n>0))break;o=h-1}}return 0>n&&h++,h},World.prototype.init=function(){var t=this,i=window.webkitRequestAnimationFrame||window.requestAnimationFrame;i(function s(e){t.render(e),i(s)})},World.prototype.project=function(t,i,s){return{x:Math.round((t-i)*this.cell.width/2),y:Math.round(((t+i)/2+s)*this.cell.height)}},World.prototype.render=function(t){if(this._changed){this._changed=!1,this.cx=Math.round(this.width/2-this.projection.x),this.cy=Math.round(this.height/2-this.projection.y),this.ctx.save(),this.ctx.clearRect(0,0,this.width,this.height),this.ctx.translate(this.cx,this.cy);for(var i=0;i<this.regions.length;i++)this.regions[i].isVisible(this.center.z)&&(this.regions[i].sort(),this.regions[i].render(t));this.ctx.restore()}},World.prototype.add=function(t){var i=this.getRegion(t);if(!i){var s=10*Math.round(t.x/10)+5,e=10*Math.round(t.y/10)+5,o=10*Math.round(t.z/10)+5;i=new Region(s,e,o),this.addRegion(i)}i.add(t)},World.prototype.getRegion=function(t){for(var i=0,s=this.regions.length;s>i;i++)if(this.regions[i].contains(t))return this.regions[i];return!1},World.prototype.addRegion=function(t){t.init(this),this.regions.push(t)},World.prototype.setPlayer=function(t){this.player=t,this.setCenter(t.x,t.y,t.z),this.add(t)},World.prototype.setCenter=function(t,i,s,e){this.center={x:t,y:i,z:s},this.projection=this.project(t,i,s),(0===this.regions.length||e)&&this.regions.sort(Region.compare)},World.prototype.handleMove=function(t){var i=!1;if(!t.region.contains(t)){i=!0,t.remove();for(var s=0;s<this.regions.length;s++)if(this.regions[s].contains(t)){this.regions[s].add(t);break}}this.player===t&&this.setCenter(t.x,t.y,t.z,i)},World.prototype.hasObstacle=function(t,i,s){var e=this.getRegion({x:t,y:i,z:s});return e?!!e.get(t,i,s):!0},Item.prototype.init=function(t){this.region=t,this.world=t.world,this.ctx=t.ctx,this.position(this.x,this.y,this.z),this.offset(this.sx,this.sy)},Item.prototype.position=function(t,i,s){this.x=t,this.y=i,this.z=s,this.projection=this.world.project(this.x,this.y,this.z),this.world.handleMove(this),this.world._changed=!0},Item.prototype.in=function(t,i,s,e){var o=this.width,h=this.height,n=this.projection;return n.x+o>=t&&n.x-o<=s&&n.y+h>=i&&n.y-h<=e},Item.prototype.offset=function(t,i){this.sx=t||0,this.sy=i||0,this.world._changed=!0},Item.prototype.move=function(t,i,s){this.position(this.x+t,this.y+i,this.z+s)},Item.prototype.covers=function(t){if(Item.compare(this,t)<=0||this===t)return!1;var i=this.projection.x-t.projection.x,s=this.projection.y-t.projection.y,e=i*i+s*s;return 3e3>e?!0:void 0},Item.prototype.neighbors=function(t){var i=this.x-t.x,s=this.y-t.y,e=i*i+s*s;return 9>e?!0:void 0},Item.prototype.render=function(){},Item.prototype.animate=function(t,i,s){this.animations.push(new Animation(this,t,i,s)),this.world._changed=!0},Item.prototype.animation=function(t){if(0!==this.animations.length)for(;0!==this.animations.length;){var i=this.animations[0];i.init(t);{if(!(i.start+i.duration<=t)){i.run(t),this.world._changed=!0;break}this.animations.shift(),i.end()}}},Item.prototype.reset=function(){if(0!==this.animation.length){for(var t=0,i=this.animation.length;i>t;t++){var s=this.animation[t];s.init(),s.end()}this.animation=[]}},Item.prototype.remove=function(){this.region.remove(this)},Item.compare=function(t,i){return t.z>i.z?-1:t.z<i.z?1:t.x+t.y-i.x-i.y},Block.prototype=Object.create(Item.prototype),Block.prototype.constructor=Block,Block.prototype.render=function(){this.ctx.drawImage(this.sprite,this.sx,this.sy,this.width,this.height,this.projection.x-32,this.projection.y-16,this.width,this.height)},Player.prototype=Object.create(Item.prototype),Player.prototype.constructor=Player,Player.prototype.command=function(t,i,s){if("move"===t){var e=0;i.y>0?e=192:i.x>0?e=64:i.x<0&&(e=128),this.animate({x:i.x,y:i.y,z:i.z,sy:e,frames:4},300,s)}else s()},Player.prototype.render=function(){this.ctx.drawImage(this.sprite,this.sx,this.sy,this.width,this.height,this.projection.x-32,this.projection.y-24,this.width,this.height)},Animation.prototype.init=function(t){null===this.start&&(this.start=t,this.initial={x:this.item.x,y:this.item.y,z:this.item.z},this.item.world.hasObstacle(this.initial.x+this.x,this.initial.y+this.y,this.initial.z+this.z)&&(this.x=0,this.y=0,this.z=0))},Animation.prototype.run=function(t){var i=(t-this.start)/this.duration,s=Math.round(i*(this.frames-1));this.item.offset(this.item.width*s,this.sy),this.transform(i)},Animation.prototype.transform=function(t){this.item.position(this.initial.x+this.x*t,this.initial.y+this.y*t,this.initial.z+this.z*t)},Animation.prototype.end=function(){this.transform(1),this.sprite&&(this.item.sprite=this.sprite),this.callback&&this.callback()};
//# sourceMappingURL=isomer.min.js.map